



 // quản lý bài viết bản tin
// Thêm biến toàn cục
let currentNewsPage = 1;
const newsPerPage = 6;
let allNewsData = [];
// Khởi tạo dữ liệu mẫu
function initializeNewsData() {
    allNewsData = [
        {
            id: 'N001',
            title: 'Cảnh báo bão số 8 hướng vào đất liền',
            category: 'emergency',
            status: 'published',
            excerpt: 'Bão số 8 dự kiến đổ bộ vào các tỉnh miền Trung với sức gió mạnh cấp 10-11, giật cấp 13. Người dân cần chủ động các biện pháp phòng tránh.',
            content: 'Bão số 8 đang di chuyển với tốc độ nhanh và dự kiến sẽ đổ bộ vào các tỉnh miền Trung trong 24 giờ tới. Sức gió mạnh cấp 10-11, giật cấp 13. Các địa phương cần khẩn trương triển khai các biện pháp phòng chống bão.',
            views: 2400,
            time: '2 giờ trước',
            author: 'Admin System',
            priority: 'high',
            imageUrl: '',
            scheduleDate: '',
            createdAt: '2024-01-15T10:30:00'
        },
        {
            id: 'N002',
            title: 'Hướng dẫn sơ cứu khi bị điện giật',
            category: 'guidance', 
            status: 'published',
            excerpt: 'Các bước sơ cứu cơ bản khi gặp nạn nhân bị điện giật cần thực hiện ngay lập tức để tránh nguy hiểm tính mạng.',
            content: 'Khi gặp nạn nhân bị điện giật, cần thực hiện các bước sau: 1. Ngắt nguồn điện ngay lập tức, 2. Kiểm tra ý thức nạn nhân, 3. Gọi cấp cứu 115, 4. Thực hiện hồi sức tim phổi nếu cần.',
            views: 1800,
            time: '5 giờ trước',
            author: 'Nguyễn Văn A',
            priority: 'medium',
            imageUrl: '',
            scheduleDate: '',
            createdAt: '2024-01-15T08:15:00'
        },
        {
            id: 'N003',
            title: 'Thông báo lịch cứu hộ dịp lễ 30/4',
            category: 'info',
            status: 'scheduled',
            excerpt: 'Lịch trực và phương án cứu hộ được triển khai trong dịp lễ 30/4 - 1/5 để đảm bảo an toàn cho người dân.',
            content: 'Trong dịp lễ 30/4 - 1/5, lực lượng cứu hộ sẽ được bố trí trực 24/24 tại các điểm nóng. Phương án cứu hộ khẩn cấp đã được xây dựng và sẵn sàng triển khai.',
            views: 950,
            time: '1 ngày trước',
            author: 'Trần Thị B',
            priority: 'low',
            imageUrl: '',
            scheduleDate: '2024-04-28T08:00:00',
            createdAt: '2024-01-14T14:20:00'
        },
        // ... thêm các bài viết khác từ dữ liệu trước
        {
            id: 'N010',
            title: 'Cảnh báo triều cường tại khu vực ven biển',
            category: 'warning',
            status: 'published',
            excerpt: 'Triều cường dâng cao gây ngập lụt tại các khu vực ven biển. Người dân cần đề phòng.',
            content: 'Triều cường đang dâng cao tại các khu vực ven biển, đặc biệt là các tỉnh Cà Mau, Bạc Liêu, Sóc Trăng. Mực nước có thể dâng cao hơn 1.5m so với bình thường.',
            views: 1900,
            time: '5 giờ trước',
            author: 'Admin System',
            priority: 'medium',
            imageUrl: '',
            scheduleDate: '',
            createdAt: '2024-01-15T07:45:00'
        }
    ];
}

// Cập nhật hàm loadNewsData
function loadNewsData(page = 1, filters = {}) {
    const container = document.getElementById('news-grid-container');
    if (!container) return;
    
    container.innerHTML = '';

    // Áp dụng filters
    let filteredNews = applyNewsFilters(allNewsData, filters);
    
    // Tính toán phân trang
    const startIndex = (page - 1) * newsPerPage;
    const endIndex = startIndex + newsPerPage;
    const paginatedNews = filteredNews.slice(startIndex, endIndex);

    // Cập nhật thông tin hiển thị
    updateNewsPaginationInfo(filteredNews.length, page);

    if (paginatedNews.length === 0) {
        container.innerHTML = `
            <div class="col-span-full text-center py-12">
                <i class="fas fa-inbox text-gray-400 text-4xl mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">Không có bài viết nào</h3>
                <p class="text-gray-500">Không tìm thấy bài viết nào phù hợp với tiêu chí của bạn.</p>
                <button onclick="openNewsModal()" class="mt-4 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">
                    <i class="fas fa-plus mr-2"></i>
                    Thêm bài viết mới
                </button>
            </div>
        `;
        return;
    }

    // Render danh sách bài viết
    renderNewsList(paginatedNews);
    
    // Render phân trang
    renderNewsPagination(filteredNews.length, page);
    
    // Thêm event listeners
    addNewsActionListeners();
}

// Hàm áp dụng filters
function applyNewsFilters(news, filters) {
    let filtered = [...news];
    
    // Filter theo category
    if (filters.category && filters.category !== 'all') {
        filtered = filtered.filter(item => item.category === filters.category);
    }
    
    // Filter theo status
    if (filters.status && filters.status !== 'all') {
        filtered = filtered.filter(item => item.status === filters.status);
    }
    
    // Filter theo search
    if (filters.search) {
        const searchTerm = filters.search.toLowerCase();
        filtered = filtered.filter(item => 
            item.title.toLowerCase().includes(searchTerm) ||
            item.excerpt.toLowerCase().includes(searchTerm) ||
            item.author.toLowerCase().includes(searchTerm)
        );
    }
    
    return filtered;
}

// Hàm render danh sách bài viết
function renderNewsList(newsList) {
    const container = document.getElementById('news-grid-container');
    
    newsList.forEach(news => {
        const categoryNames = {
            'emergency': 'Khẩn cấp',
            'warning': 'Cảnh báo', 
            'info': 'Thông tin',
            'guidance': 'Hướng dẫn',
            'news': 'Tin tức'
        };

        const statusNames = {
            'published': 'Đã xuất bản',
            'draft': 'Bản nháp',
            'scheduled': 'Lên lịch',
            'archived': 'Đã lưu trữ'
        };

        const categoryColors = {
            'emergency': 'bg-red-100 text-red-800 border-red-200',
            'warning': 'bg-orange-100 text-orange-800 border-orange-200',
            'info': 'bg-blue-100 text-blue-800 border-blue-200',
            'guidance': 'bg-green-100 text-green-800 border-green-200',
            'news': 'bg-purple-100 text-purple-800 border-purple-200'
        };

        const statusColors = {
            'published': 'bg-green-100 text-green-800',
            'draft': 'bg-yellow-100 text-yellow-800',
            'scheduled': 'bg-blue-100 text-blue-800',
            'archived': 'bg-gray-100 text-gray-800'
        };

        const priorityIcons = {
            'high': 'fas fa-exclamation-circle text-red-500',
            'medium': 'fas fa-info-circle text-yellow-500',
            'low': 'fas fa-flag text-green-500'
        };

        const card = document.createElement('div');
        card.className = `bg-white rounded-xl shadow-sm overflow-hidden border border-gray-200 hover:shadow-md transition-all duration-200 transform hover:-translate-y-1`;
        card.innerHTML = `
            <div class="p-6">
                <div class="flex justify-between items-start mb-3">
                    <div class="flex items-center space-x-2">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${categoryColors[news.category]} border">
                            ${categoryNames[news.category]}
                        </span>
                        <i class="${priorityIcons[news.priority]}" title="Ưu tiên ${news.priority}"></i>
                    </div>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColors[news.status]}">
                        ${statusNames[news.status]}
                    </span>
                </div>
                
                <h3 class="font-bold text-lg mb-2 text-gray-900 line-clamp-2 hover:text-red-600 cursor-pointer view-news" data-id="${news.id}">
                    ${news.title}
                </h3>
                
                <p class="text-gray-600 text-sm mb-4 line-clamp-3">${news.excerpt}</p>
                
                <div class="flex items-center justify-between text-sm text-gray-500 mb-3">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center">
                            <i class="fas fa-eye mr-1"></i>
                            <span>${news.views.toLocaleString()}</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-clock mr-1"></i>
                            <span>${news.time}</span>
                        </div>
                    </div>
                    <div class="text-xs text-gray-400">
                        ${formatDate(news.createdAt)}
                    </div>
                </div>
                
                <div class="flex items-center justify-between pt-3 border-t border-gray-100">
                    <span class="text-sm text-gray-500">Bởi <strong class="text-gray-700">${news.author}</strong></span>
                    <div class="flex space-x-1">
                        <button class="text-blue-600 hover:text-blue-800 p-2 rounded-lg hover:bg-blue-50 transition view-news" data-id="${news.id}" title="Xem chi tiết">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="text-green-600 hover:text-green-800 p-2 rounded-lg hover:bg-green-50 transition edit-news" data-id="${news.id}" title="Chỉnh sửa">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-red-600 hover:text-red-800 p-2 rounded-lg hover:bg-red-50 transition delete-news" data-id="${news.id}" title="Xóa">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(card);
    });
}

// Hàm format ngày tháng
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('vi-VN', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    });
}

// Hàm cập nhật thông tin phân trang
function updateNewsPaginationInfo(totalItems, currentPage) {
    const showingFrom = document.getElementById('showing-from');
    const showingTo = document.getElementById('showing-to');
    const totalItemsElement = document.getElementById('total-items');
    
    if (showingFrom && showingTo && totalItemsElement) {
        const startIndex = (currentPage - 1) * newsPerPage + 1;
        const endIndex = Math.min(currentPage * newsPerPage, totalItems);
        
        showingFrom.textContent = startIndex;
        showingTo.textContent = endIndex;
        totalItemsElement.textContent = totalItems;
    }
}

// Hàm render phân trang
function renderNewsPagination(totalItems, currentPage) {
    const paginationContainer = document.querySelector('#news .flex.justify-between.items-center');
    if (!paginationContainer) return;
    
    const totalPages = Math.ceil(totalItems / newsPerPage);
    
    // Tìm phần tử pagination buttons
    let paginationButtons = paginationContainer.querySelector('.flex.space-x-2');
    if (!paginationButtons) {
        paginationButtons = document.createElement('div');
        paginationButtons.className = 'flex space-x-2';
        paginationContainer.appendChild(paginationButtons);
    }
    
    paginationButtons.innerHTML = '';
    
    // Nút Previous
    const prevButton = document.createElement('button');
    prevButton.className = `px-3 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition ${
        currentPage === 1 ? 'opacity-50 cursor-not-allowed' : ''
    }`;
    prevButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
    prevButton.disabled = currentPage === 1;
    prevButton.addEventListener('click', () => {
        if (currentPage > 1) {
            currentNewsPage = currentPage - 1;
            loadNewsData(currentNewsPage, getCurrentFilters());
        }
    });
    paginationButtons.appendChild(prevButton);
    
    // Các nút trang
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    // Nút trang đầu
    if (startPage > 1) {
        const firstPageButton = document.createElement('button');
        firstPageButton.className = 'px-3 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition';
        firstPageButton.textContent = '1';
        firstPageButton.addEventListener('click', () => {
            currentNewsPage = 1;
            loadNewsData(currentNewsPage, getCurrentFilters());
        });
        paginationButtons.appendChild(firstPageButton);
        
        if (startPage > 2) {
            const ellipsis = document.createElement('span');
            ellipsis.className = 'px-3 py-2 text-gray-500';
            ellipsis.textContent = '...';
            paginationButtons.appendChild(ellipsis);
        }
    }
    
    // Các nút trang chính
    for (let i = startPage; i <= endPage; i++) {
        const pageButton = document.createElement('button');
        pageButton.className = `px-3 py-2 border rounded-lg font-medium transition ${
            i === currentPage 
                ? 'bg-red-600 text-white border-red-600' 
                : 'border-gray-300 text-gray-700 hover:bg-gray-50'
        }`;
        pageButton.textContent = i;
        pageButton.addEventListener('click', () => {
            currentNewsPage = i;
            loadNewsData(currentNewsPage, getCurrentFilters());
        });
        paginationButtons.appendChild(pageButton);
    }
    
    // Nút trang cuối
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            const ellipsis = document.createElement('span');
            ellipsis.className = 'px-3 py-2 text-gray-500';
            ellipsis.textContent = '...';
            paginationButtons.appendChild(ellipsis);
        }
        
        const lastPageButton = document.createElement('button');
        lastPageButton.className = 'px-3 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition';
        lastPageButton.textContent = totalPages;
        lastPageButton.addEventListener('click', () => {
            currentNewsPage = totalPages;
            loadNewsData(currentNewsPage, getCurrentFilters());
        });
        paginationButtons.appendChild(lastPageButton);
    }
    
    // Nút Next
    const nextButton = document.createElement('button');
    nextButton.className = `px-3 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition ${
        currentPage === totalPages ? 'opacity-50 cursor-not-allowed' : ''
    }`;
    nextButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
    nextButton.disabled = currentPage === totalPages;
    nextButton.addEventListener('click', () => {
        if (currentPage < totalPages) {
            currentNewsPage = currentPage + 1;
            loadNewsData(currentNewsPage, getCurrentFilters());
        }
    });
    paginationButtons.appendChild(nextButton);
}

// Hàm lấy filters hiện tại
function getCurrentFilters() {
    return {
        category: document.getElementById('category-news-filter')?.value || 'all',
        status: document.getElementById('status-news-filter')?.value || 'all',
        search: document.getElementById('search-news-input')?.value || ''
    };
}

// Hàm thêm event listeners
function addNewsActionListeners() {
    // Event listeners cho các nút hành động
    document.querySelectorAll('.view-news').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const id = e.currentTarget.getAttribute('data-id');
            viewNews(id);
        });
    });

    document.querySelectorAll('.edit-news').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const id = e.currentTarget.getAttribute('data-id');
            editNews(id);
        });
    });

    document.querySelectorAll('.delete-news').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const id = e.currentTarget.getAttribute('data-id');
            deleteNews(id);
        });
    });
}

// Hàm mở modal thêm bài viết
function openNewsModal() {
    currentEditingNews = null;
    document.getElementById('news-modal-title').textContent = 'Thêm bài viết mới';
    resetNewsForm();
    document.getElementById('news-modal').classList.remove('hidden');
}

// Hàm đóng modal bài viết
function closeNewsModal() {
    document.getElementById('news-modal').classList.add('hidden');
    resetNewsForm();
}

// Hàm reset form bài viết
function resetNewsForm() {
    document.getElementById('news-form').reset();
    document.getElementById('schedule-field').classList.add('hidden');
    document.getElementById('image-preview').classList.add('hidden');
    document.getElementById('news-id').value = '';
    currentEditingNews = null;
    
    // Reset editor nếu có
    if (typeof quill !== 'undefined') {
        quill.setText('');
    }
}

// Hàm chỉnh sửa bài viết - ĐÃ SỬA
function editNews(id) {
    const news = allNewsData.find(item => item.id === id);
    
    if (news) {
        currentEditingNews = id;
        document.getElementById('news-modal-title').textContent = 'Chỉnh sửa bài viết';
        
        // Điền dữ liệu vào form
        document.getElementById('news-title').value = news.title || '';
        document.getElementById('news-category').value = news.category || '';
        document.getElementById('news-status').value = news.status || 'draft';
        document.getElementById('news-priority').value = news.priority || 'medium';
        document.getElementById('news-excerpt').value = news.excerpt || '';
        document.getElementById('news-content').value = news.content || '';
        
        // Xử lý trường lịch trình
        const scheduleField = document.getElementById('schedule-field');
        if (news.status === 'scheduled' && news.scheduleDate) {
            scheduleField.classList.remove('hidden');
            // Format datetime-local
            const scheduleDate = new Date(news.scheduleDate);
            const formattedDate = scheduleDate.toISOString().slice(0, 16);
            document.getElementById('news-schedule').value = formattedDate;
        } else {
            scheduleField.classList.add('hidden');
        }
        
        // Xử lý hình ảnh preview nếu có
        const imagePreview = document.getElementById('image-preview');
        if (news.imageUrl) {
            imagePreview.classList.remove('hidden');
            imagePreview.querySelector('img').src = news.imageUrl;
        } else {
            imagePreview.classList.add('hidden');
        }
        
        document.getElementById('news-modal').classList.remove('hidden');
    } else {
        showNotification('Không tìm thấy bài viết để chỉnh sửa', 'error');
    }
}

// Hàm xem chi tiết bài viết
function viewNews(id) {
    const news = allNewsData.find(item => item.id === id);
    if (news) {
        // Tạo modal xem chi tiết
        const modalHtml = `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-900">${news.title}</h3>
                            <button onclick="closeNewsDetailModal()" class="text-gray-400 hover:text-gray-500">
                                <i class="fas fa-times text-lg"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="flex flex-wrap gap-2 mb-4">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                ${getCategoryName(news.category)}
                            </span>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                ${getStatusName(news.status)}
                            </span>
                            <span class="text-sm text-gray-500">Lượt xem: ${news.views.toLocaleString()}</span>
                        </div>
                        <div class="prose max-w-none">
                            <p class="text-gray-600 mb-4">${news.excerpt}</p>
                            <div class="text-gray-700 whitespace-pre-line">${news.content}</div>
                        </div>
                        <div class="mt-6 pt-6 border-t border-gray-200">
                            <div class="flex justify-between text-sm text-gray-500">
                                <span>Tác giả: <strong>${news.author}</strong></span>
                                <span>Đăng lúc: ${formatDateTime(news.createdAt)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Tạo và hiển thị modal
        const modalContainer = document.createElement('div');
        modalContainer.id = 'news-detail-modal';
        modalContainer.innerHTML = modalHtml;
        document.body.appendChild(modalContainer);
    }
}

// Hàm đóng modal chi tiết
function closeNewsDetailModal() {
    const modal = document.getElementById('news-detail-modal');
    if (modal) {
        modal.remove();
    }
}

// Hàm xóa bài viết
function deleteNews(id) {
    if (confirm('Bạn có chắc chắn muốn xóa bài viết này? Hành động này không thể hoàn tác.')) {
        // Trong thực tế sẽ gọi API xóa
        allNewsData = allNewsData.filter(item => item.id !== id);
        loadNewsData(currentNewsPage, getCurrentFilters());
        showNotification('Bài viết đã được xóa thành công!');
    }
}

// Helper functions
function getCategoryName(category) {
    const categoryNames = {
        'emergency': 'Khẩn cấp',
        'warning': 'Cảnh báo', 
        'info': 'Thông tin',
        'guidance': 'Hướng dẫn',
        'news': 'Tin tức'
    };
    return categoryNames[category] || category;
}

function getStatusName(status) {
    const statusNames = {
        'published': 'Đã xuất bản',
        'draft': 'Bản nháp',
        'scheduled': 'Lên lịch',
        'archived': 'Đã lưu trữ'
    };
    return statusNames[status] || status;
}

function formatDateTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString('vi-VN', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Khởi tạo khi DOM ready
document.addEventListener('DOMContentLoaded', function() {
    initializeNewsData();
    
    // Thêm event listeners cho filters
    document.getElementById('search-news-input')?.addEventListener('input', debounce(() => {
        currentNewsPage = 1;
        loadNewsData(currentNewsPage, getCurrentFilters());
    }, 300));
    
    document.getElementById('category-news-filter')?.addEventListener('change', () => {
        currentNewsPage = 1;
        loadNewsData(currentNewsPage, getCurrentFilters());
    });
    
    document.getElementById('status-news-filter')?.addEventListener('change', () => {
        currentNewsPage = 1;
        loadNewsData(currentNewsPage, getCurrentFilters());
    });
    
    // Load dữ liệu ban đầu
    loadNewsData(currentNewsPage);
});

// Hàm debounce cho search
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}





        // News Management JavaScript
    document.addEventListener('DOMContentLoaded', function() {
        initializeNewsManagement();
        loadNewsData();
    });

    function initializeNewsManagement() {
        // Event listeners for news management
        document.getElementById('add-news-btn').addEventListener('click', openNewsModal);
        document.getElementById('close-news-modal').addEventListener('click', closeNewsModal);
        document.getElementById('cancel-news').addEventListener('click', closeNewsModal);
        document.getElementById('toggle-news-filters').addEventListener('click', toggleAdvancedFilters);
        document.getElementById('news-status').addEventListener('change', handleStatusChange);
        document.getElementById('image-upload').addEventListener('change', handleImageUpload);
        document.getElementById('publish-news-btn').addEventListener('click', publishNews);
        document.getElementById('save-draft-btn').addEventListener('click', saveDraft);
        
        // Filter events
        document.getElementById('search-news-input').addEventListener('input', applyNewsFilters);
        document.getElementById('category-news-filter').addEventListener('change', applyNewsFilters);
        document.getElementById('status-news-filter').addEventListener('change', applyNewsFilters);
    }


    // Tab Management System
document.addEventListener('DOMContentLoaded', function() {
    initializeTabSystem();
    initializeNewsManagement();
    loadNewsData();
});

function initializeTabSystem() {
    // Navigation click handlers
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const tabName = this.getAttribute('data-tab');
            showTab(tabName);
            
            // Update active state in sidebar
            document.querySelectorAll('.nav-item').forEach(nav => {
                nav.classList.remove('active', 'bg-red-600', 'text-white');
                nav.classList.add('text-gray-300', 'hover:text-white', 'hover:bg-gray-800');
            });
            this.classList.add('active', 'bg-red-600', 'text-white');
            this.classList.remove('text-gray-300', 'hover:text-white', 'hover:bg-gray-800');
        });
    });
}

function showTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Show selected tab
    const selectedTab = document.getElementById(tabName);
    if (selectedTab) {
        selectedTab.classList.add('active');
    }
    
    // Update page header based on tab
    updatePageHeader(tabName);
    
    // Load specific data for the tab
    loadTabData(tabName);
}

function updatePageHeader(tabName) {
    const titles = {
        'dashboard': 'Dashboard',
        'news': 'Quản lý Tin tức & Bài viết',
        'weather': 'Quản lý Dự báo Thời tiết',
        'reports': 'Quản lý Báo cáo Sự cố',
        'incidents': 'Sự cố Đang xử lý',
        'users': 'Quản lý Tài khoản',
        'roles': 'Quản lý Phân quyền',
        'analytics': 'Phân tích & Báo cáo',
        'settings': 'Cài đặt Hệ thống',
        'logs': 'Nhật ký Hệ thống'
    };
    
    const descriptions = {
        'dashboard': 'Tổng quan hệ thống cứu hộ quốc gia',
        'news': 'Quản lý và xuất bản các tin tức khẩn cấp và bài viết thông thường',
        'weather': 'Dự báo thời tiết và cảnh báo thiên tai',
        'reports': 'Xem và xử lý các báo cáo khẩn cấp từ người dùng',
        'incidents': 'Theo dõi và quản lý các sự cố đang được xử lý',
        'users': 'Quản lý tài khoản người dùng hệ thống',
        'roles': 'Quản lý phân quyền và vai trò người dùng',
        'analytics': 'Phân tích dữ liệu và báo cáo thống kê',
        'settings': 'Cấu hình hệ thống và các tùy chọn nâng cao',
        'logs': 'Theo dõi nhật ký hoạt động hệ thống'
    };
    
    const titleElement = document.getElementById('page-title');
    const descriptionElement = document.getElementById('page-description');
    
    if (titleElement && descriptionElement) {
        titleElement.textContent = titles[tabName] || 'Dashboard';
        descriptionElement.textContent = descriptions[tabName] || 'Tổng quan hệ thống cứu hộ quốc gia';
    }
}

function loadTabData(tabName) {
    switch(tabName) {
        case 'news':
            loadNewsData();
            break;
        case 'weather':
            loadWeatherData();
            break;
        case 'reports':
            loadReportsData();
            break;
        case 'users':
            loadUsersData();
            break;
        // Add other cases as needed
    }
}

let currentEditingNews = null;

function initializeNewsManagement() {
    // Event listeners cho quản lý tin tức
    const addNewsBtn = document.getElementById('add-news-btn');
    const closeNewsModal = document.getElementById('close-news-modal');
    const cancelNews = document.getElementById('cancel-news');
    const toggleFilters = document.getElementById('toggle-news-filters');
    const newsStatus = document.getElementById('news-status');
    const imageUpload = document.getElementById('image-upload');
    const publishNewsBtn = document.getElementById('publish-news-btn');
    const saveDraftBtn = document.getElementById('save-draft-btn');
    
    if (addNewsBtn) addNewsBtn.addEventListener('click', () => openNewsModal());
    if (closeNewsModal) closeNewsModal.addEventListener('click', closeNewsModal);
    if (cancelNews) cancelNews.addEventListener('click', closeNewsModal);
    if (toggleFilters) toggleFilters.addEventListener('click', toggleAdvancedFilters);
    if (newsStatus) newsStatus.addEventListener('change', handleStatusChange);
    if (imageUpload) imageUpload.addEventListener('change', handleImageUpload);
    if (publishNewsBtn) publishNewsBtn.addEventListener('click', publishNews);
    if (saveDraftBtn) saveDraftBtn.addEventListener('click', saveDraft);
    
    // Filter events
    const searchInput = document.getElementById('search-news-input');
    const categoryFilter = document.getElementById('category-news-filter');
    const statusFilter = document.getElementById('status-news-filter');
    
    if (searchInput) searchInput.addEventListener('input', applyNewsFilters);
    if (categoryFilter) categoryFilter.addEventListener('change', applyNewsFilters);
    if (statusFilter) statusFilter.addEventListener('change', applyNewsFilters);
    
    // Thêm event listener để đóng modal khi click bên ngoài
    document.addEventListener('click', function(e) {
        const newsModal = document.getElementById('news-modal');
        if (e.target === newsModal) {
            closeNewsModal();
        }
    });
}

function loadNewsData() {
    const container = document.getElementById('news-grid-container');
    if (!container) return;
    
    container.innerHTML = '';

    // Sample news data
    const sampleNews = [
        {
            id: 'N001',
            title: 'Cảnh báo bão số 8 hướng vào đất liền',
            category: 'emergency',
            status: 'published',
            excerpt: 'Bão số 8 dự kiến đổ bộ vào các tỉnh miền Trung với sức gió mạnh cấp 10-11, giật cấp 13. Người dân cần chủ động các biện pháp phòng tránh.',
            views: 2400,
            time: '2 giờ trước',
            author: 'Admin System',
            priority: 'high'
        },
        {
            id: 'N002',
            title: 'Hướng dẫn sơ cứu khi bị điện giật',
            category: 'guidance', 
            status: 'published',
            excerpt: 'Các bước sơ cứu cơ bản khi gặp nạn nhân bị điện giật cần thực hiện ngay lập tức để tránh nguy hiểm tính mạng.',
            views: 1800,
            time: '5 giờ trước',
            author: 'Nguyễn Văn A',
            priority: 'medium'
        },
        {
            id: 'N003',
            title: 'Thông báo lịch cứu hộ dịp lễ 30/4',
            category: 'info',
            status: 'scheduled',
            excerpt: 'Lịch trực và phương án cứu hộ được triển khai trong dịp lễ 30/4 - 1/5 để đảm bảo an toàn cho người dân.',
            views: 950,
            time: '1 ngày trước',
            author: 'Trần Thị B',
            priority: 'low'
        }
    ];

    sampleNews.forEach(news => {
        const categoryNames = {
            'emergency': 'Khẩn cấp',
            'warning': 'Cảnh báo', 
            'info': 'Thông tin',
            'guidance': 'Hướng dẫn',
            'news': 'Tin tức'
        };

        const statusNames = {
            'published': 'Đã xuất bản',
            'draft': 'Bản nháp',
            'scheduled': 'Lên lịch',
            'archived': 'Đã lưu trữ'
        };

        const categoryColors = {
            'emergency': 'bg-red-100 text-red-800',
            'warning': 'bg-orange-100 text-orange-800',
            'info': 'bg-blue-100 text-blue-800',
            'guidance': 'bg-green-100 text-green-800',
            'news': 'bg-purple-100 text-purple-800'
        };

        const statusColors = {
            'published': 'status-published',
            'draft': 'status-draft',
            'scheduled': 'status-scheduled',
            'archived': 'status-archived'
        };

        const card = document.createElement('div');
        card.className = `news-card ${news.category} bg-white rounded-xl shadow-sm overflow-hidden border`;
        card.innerHTML = `
            <div class="p-6">
                <div class="flex justify-between items-start mb-3">
                    <span class="category-badge ${categoryColors[news.category]}">
                        ${categoryNames[news.category]}
                    </span>
                    <div class="flex items-center text-sm text-gray-500">
                        <span class="status-dot ${statusColors[news.status]}"></span>
                        ${statusNames[news.status]}
                    </div>
                </div>
                <h3 class="font-bold text-lg mb-2 text-gray-900 line-clamp-2">${news.title}</h3>
                <p class="text-gray-600 text-sm mb-4 line-clamp-3">${news.excerpt}</p>
                
                <div class="flex items-center justify-between text-sm text-gray-500 mb-3">
                    <div class="flex items-center">
                        <i class="fas fa-eye mr-1"></i>
                        <span>${news.views.toLocaleString()}</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-clock mr-1"></i>
                        <span>${news.time}</span>
                    </div>
                </div>
                
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-500">Bởi <strong>${news.author}</strong></span>
                    <div class="flex space-x-2">
                        <button class="text-blue-600 hover:text-blue-800 p-1 view-news" data-id="${news.id}" title="Xem chi tiết">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="text-green-600 hover:text-green-800 p-1 edit-news" data-id="${news.id}" title="Chỉnh sửa">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-red-600 hover:text-red-800 p-1 delete-news" data-id="${news.id}" title="Xóa">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(card);
    });

    // Add event listeners to action buttons
    container.querySelectorAll('.view-news').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const id = e.currentTarget.getAttribute('data-id');
            viewNews(id);
        });
    });

    container.querySelectorAll('.edit-news').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const id = e.currentTarget.getAttribute('data-id');
            editNews(id);
        });
    });

    container.querySelectorAll('.delete-news').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const id = e.currentTarget.getAttribute('data-id');
            deleteNews(id);
        });
    });
}

function openNewsModal() {
    document.getElementById('news-modal-title').textContent = 'Thêm bài viết mới';
    document.getElementById('news-form').reset();
    document.getElementById('image-preview').classList.add('hidden');
    document.getElementById('schedule-field').classList.add('hidden');
    document.getElementById('news-modal').classList.remove('hidden');
}

function closeNewsModal() {
    document.getElementById('news-modal').classList.add('hidden');
}

function toggleAdvancedFilters() {
    const filters = document.getElementById('advanced-news-filters');
    if (filters) {
        filters.classList.toggle('hidden');
    }
}

function handleStatusChange(e) {
    const scheduleField = document.getElementById('schedule-field');
    if (scheduleField) {
        if (e.target.value === 'scheduled') {
            scheduleField.classList.remove('hidden');
        } else {
            scheduleField.classList.add('hidden');
        }
    }
}

function handleImageUpload(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const imagePreview = document.getElementById('image-preview');
            if (imagePreview) {
                imagePreview.querySelector('img').src = e.target.result;
                imagePreview.classList.remove('hidden');
            }
        };
        reader.readAsDataURL(file);
    }
}

function publishNews() {
    const title = document.getElementById('news-title').value;
    const category = document.getElementById('news-category').value;
    
    if (!title || !category) {
        showNotification('Vui lòng điền đầy đủ thông tin bắt buộc', 'error');
        return;
    }

    showNotification('Bài viết đã được xuất bản thành công!');
    closeNewsModal();
}

function saveDraft() {
    showNotification('Đã lưu bản nháp thành công!');
    closeNewsModal();
}

function viewNews(id) {
    alert(`Xem chi tiết bài viết ID: ${id}`);
}

function editNews(id) {
    alert(`Chỉnh sửa bài viết ID: ${id}`);
    openNewsModal();
}

function deleteNews(id) {
    if (confirm('Bạn có chắc chắn muốn xóa bài viết này?')) {
        showNotification('Bài viết đã được xóa thành công!');
    }
}

function applyNewsFilters() {
    console.log('Applying news filters...');
}

function showNotification(message, type = 'success') {
    const notification = document.getElementById('success-notification');
    const messageElement = document.getElementById('notification-message');
    
    if (notification && messageElement) {
        messageElement.textContent = message;
        
        if (type === 'error') {
            notification.className = 'hidden fixed top-4 right-4 bg-red-500 text-white px-4 py-3 rounded-lg shadow-lg z-50';
        } else {
            notification.className = 'hidden fixed top-4 right-4 bg-green-500 text-white px-4 py-3 rounded-lg shadow-lg z-50';
        }
        
        notification.classList.remove('hidden');
        
        setTimeout(() => {
            notification.classList.add('hidden');
        }, 3000);
    }
}

// Placeholder functions for other tabs
function loadWeatherData() {
    console.log('Loading weather data...');
}

function loadReportsData() {
    console.log('Loading reports data...');
}

function loadUsersData() {
    console.log('Loading users data...');
}















// Reports Management Functions
function setupReportsManagement() {
    // Event listeners for reports
    document.getElementById('add-report-btn').addEventListener('click', () => openReportModal());
    document.getElementById('toggle-reports-filters').addEventListener('click', toggleReportsFilters);
    document.getElementById('sync-reports-btn').addEventListener('click', syncReportsData);
    document.getElementById('export-reports-btn').addEventListener('click', exportReportsToExcel);
    
    // Report modal events
    document.getElementById('close-report-modal').addEventListener('click', closeReportModal);
    document.getElementById('cancel-report').addEventListener('click', closeReportModal);
    document.getElementById('report-form').addEventListener('submit', handleReportSubmit);
    
    // Filter events
    document.getElementById('search-reports-input').addEventListener('input', applyReportsFilters);
    document.getElementById('type-reports-filter').addEventListener('change', applyReportsFilters);
    document.getElementById('status-reports-filter').addEventListener('change', applyReportsFilters);
    document.getElementById('priority-reports-filter').addEventListener('change', applyReportsFilters);
    document.getElementById('region-reports-filter').addEventListener('change', applyReportsFilters);
    document.getElementById('start-date-filter').addEventListener('change', applyReportsFilters);
    document.getElementById('end-date-filter').addEventListener('change', applyReportsFilters);
    
    // Image upload
    document.getElementById('report-image-upload').addEventListener('change', handleReportImageUpload);
}

function loadReportsData() {
    let reports = JSON.parse(localStorage.getItem('admin_reports')) || [];
    
    // If no data, initialize with sample data
    if (reports.length === 0) {
        reports = getSampleReportsData();
        localStorage.setItem('admin_reports', JSON.stringify(reports));
    }
    
    renderReportsTable(reports);
    updateReportsStats(reports);
}

function getSampleReportsData() {
    return [
        {
            id: 'R001',
            title: 'Cháy chung cư tại Cầu Giấy',
            type: 'fire',
            priority: 'high',
            status: 'processing',
            address: '123 Trần Duy Hưng, Cầu Giấy',
            province: 'hanoi',
            time: '2025-11-01T10:30',
            description: 'Cháy lớn tại tầng 12 chung cư Golden West, nhiều người mắc kẹt bên trong.',
            reporter: { name: 'Nguyễn Văn A', phone: '0912345678' },
            image: '',
            createdAt: new Date().toISOString()
        },
        {
            id: 'R002',
            title: 'Ngập nước nghiêm trọng tại Quận 1',
            type: 'flood',
            priority: 'medium',
            status: 'pending',
            address: 'Đường Nguyễn Huệ, Quận 1',
            province: 'hcm',
            time: '2025-11-01T14:15',
            description: 'Ngập nước sâu 0.5m sau cơn mưa lớn, nhiều phương tiện bị kẹt.',
            reporter: { name: 'Trần Thị B', phone: '0934567890' },
            image: '',
            createdAt: new Date().toISOString()
        },
        {
            id: 'R003',
            title: 'Tai nạn giao thông nghiêm trọng',
            type: 'accident',
            priority: 'critical',
            status: 'processing',
            address: 'QL1A, Quận Bình Thạnh',
            province: 'hcm',
            time: '2025-10-31T08:20',
            description: 'Va chạm giữa xe tải và xe máy, 2 người bị thương nặng.',
            reporter: { name: 'Lê Văn C', phone: '0945678901' },
            image: '',
            createdAt: new Date().toISOString()
        }
    ];
}

function renderReportsTable(reports) {
    const container = document.getElementById('reports-table-body');
    container.innerHTML = '';

    if (reports.length === 0) {
        container.innerHTML = `
            <tr>
                <td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500">
                    <div class="flex flex-col items-center justify-center py-8">
                        <i class="fas fa-inbox text-4xl text-gray-300 mb-2"></i>
                        <p class="text-gray-500">Không có báo cáo nào</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }

    reports.forEach(report => {
        const typeNames = {
            'fire': 'Cháy',
            'flood': 'Ngập lụt',
            'accident': 'Tai nạn',
            'medical': 'Y tế',
            'disaster': 'Thiên tai',
            'other': 'Khác'
        };
        
        const priorityNames = {
            'low': 'Thấp',
            'medium': 'Trung bình',
            'high': 'Cao',
            'critical': 'Rất cao'
        };
        
        const statusNames = {
            'pending': 'Đang chờ',
            'processing': 'Đang xử lý',
            'resolved': 'Đã giải quyết',
            'cancelled': 'Đã hủy'
        };
        
        const provinceNames = {
            'hanoi': 'Hà Nội',
            'hcm': 'TP. Hồ Chí Minh',
            'danang': 'Đà Nẵng',
            'haiphong': 'Hải Phòng',
            'cantho': 'Cần Thơ'
        };
        
        const priorityColors = {
            'low': 'bg-green-100 text-green-800',
            'medium': 'bg-yellow-100 text-yellow-800',
            'high': 'bg-orange-100 text-orange-800',
            'critical': 'bg-red-100 text-red-800'
        };
        
        const statusColors = {
            'pending': 'bg-gray-100 text-gray-800',
            'processing': 'bg-blue-100 text-blue-800',
            'resolved': 'bg-green-100 text-green-800',
            'cancelled': 'bg-red-100 text-red-800'
        };

        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${report.id}</td>
            <td class="px-6 py-4 text-sm text-gray-900">
                <div class="flex items-center">
                    <i class="fas ${getReportTypeIcon(report.type)} mr-2 text-gray-400"></i>
                    ${typeNames[report.type]}
                </div>
            </td>
            <td class="px-6 py-4 text-sm text-gray-500">
                <div>${report.address}</div>
                <div class="text-xs text-gray-400">${provinceNames[report.province]}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${priorityColors[report.priority]}">
                    ${priorityNames[report.priority]}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ${formatDateTime(new Date(report.time))}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColors[report.status]}">
                    ${statusNames[report.status]}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <div class="flex space-x-2">
                    <button onclick="viewReport('${report.id}')" class="text-blue-600 hover:text-blue-900 transition">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button onclick="editReport('${report.id}')" class="text-green-600 hover:text-green-900 transition">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteReport('${report.id}')" class="text-red-600 hover:text-red-900 transition">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
        container.appendChild(row);
    });
}

function getReportTypeIcon(type) {
    const icons = {
        'fire': 'fa-fire',
        'flood': 'fa-water',
        'accident': 'fa-car-crash',
        'medical': 'fa-ambulance',
        'disaster': 'fa-mountain',
        'other': 'fa-exclamation-triangle'
    };
    return icons[type] || 'fa-exclamation-triangle';
}

function updateReportsStats(reports) {
    const total = reports.length;
    const pending = reports.filter(r => r.status === 'pending').length;
    const resolved = reports.filter(r => r.status === 'resolved').length;
    const critical = reports.filter(r => r.priority === 'critical').length;

    document.getElementById('reports-total-items').textContent = total;
    // Update stats cards if they exist
    const statsCards = document.querySelectorAll('#reports .stats-card');
    if (statsCards.length >= 4) {
        statsCards[0].querySelector('.text-2xl').textContent = total;
        statsCards[1].querySelector('.text-2xl').textContent = pending;
        statsCards[2].querySelector('.text-2xl').textContent = resolved;
        statsCards[3].querySelector('.text-2xl').textContent = critical;
    }
}

// Modal Functions for Reports
function openReportModal(reportId = null) {
    const modal = document.getElementById('report-modal');
    const title = document.getElementById('report-modal-title');
    
    if (reportId) {
        title.textContent = 'Chỉnh sửa báo cáo sự cố';
        loadReportData(reportId);
    } else {
        title.textContent = 'Thêm báo cáo sự cố mới';
        document.getElementById('report-form').reset();
        document.getElementById('report-id').value = '';
        document.getElementById('report-image-preview').classList.add('hidden');
    }
    
    modal.classList.remove('hidden');
}

function closeReportModal() {
    document.getElementById('report-modal').classList.add('hidden');
}

function loadReportData(reportId) {
    const reports = JSON.parse(localStorage.getItem('admin_reports')) || [];
    const report = reports.find(r => r.id === reportId);
    
    if (report) {
        document.getElementById('report-id').value = report.id;
        document.getElementById('report-title').value = report.title;
        document.getElementById('report-type').value = report.type;
        document.getElementById('report-priority').value = report.priority;
        document.getElementById('report-status').value = report.status;
        document.getElementById('report-address').value = report.address;
        document.getElementById('report-province').value = report.province;
        document.getElementById('report-time').value = report.time.replace(' ', 'T').substring(0, 16);
        document.getElementById('report-description').value = report.description;
        document.getElementById('reporter-name').value = report.reporter.name;
        document.getElementById('reporter-phone').value = report.reporter.phone;
        
        if (report.image) {
            document.getElementById('report-image-preview').classList.remove('hidden');
            document.getElementById('report-image-preview').querySelector('img').src = report.image;
        }
    }
}

function handleReportSubmit(e) {
    e.preventDefault();
    
    const reportId = document.getElementById('report-id').value;
    const formData = {
        id: reportId || 'R' + Date.now(),
        title: document.getElementById('report-title').value,
        type: document.getElementById('report-type').value,
        priority: document.getElementById('report-priority').value,
        status: document.getElementById('report-status').value,
        address: document.getElementById('report-address').value,
        province: document.getElementById('report-province').value,
        time: document.getElementById('report-time').value,
        description: document.getElementById('report-description').value,
        reporter: {
            name: document.getElementById('reporter-name').value,
            phone: document.getElementById('reporter-phone').value
        },
        image: document.getElementById('report-image-preview').classList.contains('hidden') ? 
               '' : document.getElementById('report-image-preview').querySelector('img').src,
        createdAt: reportId ? getReportCreateTime(reportId) : new Date().toISOString()
    };
    
    saveReport(formData);
}

function getReportCreateTime(reportId) {
    const reports = JSON.parse(localStorage.getItem('admin_reports')) || [];
    const report = reports.find(r => r.id === reportId);
    return report ? report.createdAt : new Date().toISOString();
}

function saveReport(reportData) {
    let reports = JSON.parse(localStorage.getItem('admin_reports')) || [];
    
    const existingIndex = reports.findIndex(r => r.id === reportData.id);
    if (existingIndex >= 0) {
        reports[existingIndex] = reportData;
    } else {
        reports.unshift(reportData);
    }
    
    localStorage.setItem('admin_reports', JSON.stringify(reports));
    closeReportModal();
    showNotification(reportData.id ? 'Cập nhật báo cáo thành công!' : 'Thêm báo cáo mới thành công!');
    loadReportsData();
}

function viewReport(reportId) {
    const reports = JSON.parse(localStorage.getItem('admin_reports')) || [];
    const report = reports.find(r => r.id === reportId);
    
    if (report) {
        // For now, just show an alert with report details
        // In a real application, you might want to open a detailed view modal
        alert(`Chi tiết báo cáo:\n\nID: ${report.id}\nTiêu đề: ${report.title}\nLoại: ${report.type}\nMức độ: ${report.priority}\nTrạng thái: ${report.status}\nĐịa chỉ: ${report.address}\nMô tả: ${report.description}`);
    }
}

function editReport(reportId) {
    openReportModal(reportId);
}

function deleteReport(reportId) {
    if (confirm('Bạn có chắc chắn muốn xóa báo cáo này?')) {
        let reports = JSON.parse(localStorage.getItem('admin_reports')) || [];
        reports = reports.filter(r => r.id !== reportId);
        localStorage.setItem('admin_reports', JSON.stringify(reports));
        showNotification('Đã xóa báo cáo thành công!');
        loadReportsData();
    }
}

function handleReportImageUpload(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('report-image-preview');
            preview.classList.remove('hidden');
            preview.querySelector('img').src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
}

function toggleReportsFilters() {
    document.getElementById('advanced-reports-filters').classList.toggle('hidden');
}

function applyReportsFilters() {
    const searchTerm = document.getElementById('search-reports-input').value.toLowerCase();
    const typeFilter = document.getElementById('type-reports-filter').value;
    const statusFilter = document.getElementById('status-reports-filter').value;
    const priorityFilter = document.getElementById('priority-reports-filter').value;
    const regionFilter = document.getElementById('region-reports-filter').value;
    const startDate = document.getElementById('start-date-filter').value;
    const endDate = document.getElementById('end-date-filter').value;
    
    let reports = JSON.parse(localStorage.getItem('admin_reports')) || [];
    
    // Apply filters
    let filteredReports = reports.filter(report => {
        // Search filter
        if (searchTerm && !report.title.toLowerCase().includes(searchTerm) && 
            !report.description.toLowerCase().includes(searchTerm) &&
            !report.address.toLowerCase().includes(searchTerm)) {
            return false;
        }
        
        // Type filter
        if (typeFilter !== 'all' && report.type !== typeFilter) {
            return false;
        }
        
        // Status filter
        if (statusFilter !== 'all' && report.status !== statusFilter) {
            return false;
        }
        
        // Priority filter
        if (priorityFilter !== 'all' && report.priority !== priorityFilter) {
            return false;
        }
        
        // Region filter
        if (regionFilter !== 'all' && report.province !== regionFilter) {
            return false;
        }
        
        // Date range filter
        if (startDate && new Date(report.time) < new Date(startDate)) {
            return false;
        }
        
        if (endDate && new Date(report.time) > new Date(endDate + 'T23:59:59')) {
            return false;
        }
        
        return true;
    });
    
    renderReportsTable(filteredReports);
}

function syncReportsData() {
    showSyncStatus('Đang đồng bộ dữ liệu báo cáo...', 'sync-warning');
    
    setTimeout(() => {
        showSyncStatus('Đã đồng bộ dữ liệu báo cáo', 'sync-success');
        showNotification('Đồng bộ dữ liệu báo cáo thành công!');
        
        setTimeout(() => {
            hideSyncStatus();
        }, 3000);
    }, 2000);
}

function exportReportsToExcel() {
    showNotification('Đang xuất dữ liệu báo cáo ra Excel...');
    // In a real application, you would implement actual Excel export functionality
}

function formatDateTime(date) {
    return date.toLocaleString('vi-VN', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}




























//close
// Enhanced Modal Management
function setupModalHandlers() {
    // Close modals when clicking X button
    document.getElementById('close-news-modal').addEventListener('click', closeNewsModal);
    document.getElementById('close-weather-modal').addEventListener('click', closeWeatherModal);
    document.getElementById('close-report-modal').addEventListener('click', closeReportModal);
    
    // Close modals when clicking cancel buttons
    document.getElementById('cancel-news').addEventListener('click', closeNewsModal);
    document.getElementById('cancel-weather').addEventListener('click', closeWeatherModal);
    document.getElementById('cancel-report').addEventListener('click', closeReportModal);
    
    // Close modals when clicking outside
    setupClickOutsideToClose();
    
    // Close modals with Escape key
    setupEscapeKeyToClose();
}

function setupClickOutsideToClose() {
    // Close modal when clicking on overlay
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal-overlay')) {
            closeAllModals();
        }
    });
}

function setupEscapeKeyToClose() {
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeAllModals();
        }
    });
}

function closeAllModals() {
    closeNewsModal();
    closeWeatherModal();
    closeReportModal();
}

// Enhanced Modal Functions
function openNewsModal(newsId = null) {
    closeAllModals(); // Close any other open modals first
    
    const modal = document.getElementById('news-modal');
    const title = document.getElementById('news-modal-title');
    
    if (newsId) {
        title.textContent = 'Sửa tin tức';
        loadNewsData(newsId);
    } else {
        title.textContent = 'Thêm tin tức mới';
        document.getElementById('news-form').reset();
        document.getElementById('news-id').value = '';
        document.getElementById('image-preview').classList.add('hidden');
    }
    
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden'; // Prevent background scrolling
}

function closeNewsModal() {
    const modal = document.getElementById('news-modal');
    modal.classList.add('hidden');
    document.body.style.overflow = ''; // Restore scrolling
}

function openWeatherModal(weatherId = null) {
    closeAllModals();
    
    const modal = document.getElementById('weather-modal');
    const title = document.getElementById('weather-modal-title');
    
    if (weatherId) {
        title.textContent = 'Sửa dự báo thời tiết';
        loadWeatherData(weatherId);
    } else {
        title.textContent = 'Thêm dự báo thời tiết';
        document.getElementById('weather-form').reset();
        document.getElementById('weather-id').value = '';
    }
    
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeWeatherModal() {
    const modal = document.getElementById('weather-modal');
    modal.classList.add('hidden');
    document.body.style.overflow = '';
}

function openReportModal(reportId = null) {
    closeAllModals();
    
    const modal = document.getElementById('report-modal');
    const title = document.getElementById('report-modal-title');
    
    if (reportId) {
        title.textContent = 'Chỉnh sửa báo cáo sự cố';
        loadReportData(reportId);
    } else {
        title.textContent = 'Thêm báo cáo sự cố mới';
        document.getElementById('report-form').reset();
        document.getElementById('report-id').value = '';
        document.getElementById('report-image-preview').classList.add('hidden');
    }
    
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeReportModal() {
    const modal = document.getElementById('report-modal');
    modal.classList.add('hidden');
    document.body.style.overflow = '';
}

// Prevent modal content clicks from closing the modal
function setupModalClickPrevention() {
    const modals = document.querySelectorAll('.modal-content');
    modals.forEach(modal => {
        modal.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    });
}





























function loadNewsData(newsId) {
    const news = JSON.parse(localStorage.getItem('admin_news')) || [];
    const newsItem = news.find(n => n.id === newsId);
    
    if (newsItem) {
        // Fill form with existing data
        document.getElementById('news-id').value = newsItem.id;
        document.getElementById('news-title').value = newsItem.title;
        document.getElementById('news-category').value = newsItem.category;
        document.getElementById('news-status').value = newsItem.status;
        document.getElementById('news-priority').value = newsItem.priority;
        document.getElementById('news-excerpt').value = newsItem.excerpt;
        document.getElementById('news-content').value = newsItem.content;
        
        // Handle schedule field visibility
        if (newsItem.status === 'scheduled') {
            document.getElementById('schedule-field').classList.remove('hidden');
            document.getElementById('news-schedule').value = newsItem.schedule;
        }
        
        // Handle image preview
        if (newsItem.image) {
            document.getElementById('image-preview').classList.remove('hidden');
            document.getElementById('image-preview').querySelector('img').src = newsItem.image;
        }
    }
}

function loadWeatherData(weatherId) {
    const weather = JSON.parse(localStorage.getItem('admin_weather')) || [];
    const weatherItem = weather.find(w => w.id === weatherId);
    
    if (weatherItem) {
        document.getElementById('weather-id').value = weatherItem.id;
        document.getElementById('weather-date').value = weatherItem.date;
        document.getElementById('weather-region').value = weatherItem.region;
        document.getElementById('weather-type').value = weatherItem.type;
        document.getElementById('weather-temp-min').value = weatherItem.tempMin;
        document.getElementById('weather-temp-max').value = weatherItem.tempMax;
        document.getElementById('weather-description').value = weatherItem.description;
    }
}



















































//Tự động đóng modal khác khi mở modal mới

// Add this to setupEventListeners() or setupModalHandlers()
document.getElementById('news-status').addEventListener('change', function() {
    const scheduleField = document.getElementById('schedule-field');
    if (this.value === 'scheduled') {
        scheduleField.classList.remove('hidden');
    } else {
        scheduleField.classList.add('hidden');
    }
});