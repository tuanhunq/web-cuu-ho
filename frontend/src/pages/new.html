<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo Tin - Hệ Thống Cứu Hộ Quốc Gia</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.css" rel="stylesheet"> 
    <style>
        .emergency-call-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 100;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e53e3e, #c53030);
            box-shadow: 0 4px 15px rgba(229, 62, 62, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            animation: pulse 2s infinite;
            cursor: pointer;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .location-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 1px solid #5a6fd8;
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 14px;
            margin-top: 8px;
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        }
        
        .location-btn:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a45a2 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
        }
        
        .location-btn:active {
            transform: translateY(0);
        }
        
        .location-btn.loading {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .location-btn i {
            margin-right: 8px;
        }
        
        .location-loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .success-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .success-modal-content {
            background-color: white;
            border-radius: 8px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .success-icon {
            font-size: 48px;
            color: #10b981;
            margin-bottom: 20px;
        }
        
        .media-preview-item {
            position: relative;
            margin-bottom: 10px;
        }
        
        .remove-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #e53e3e;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        
        .custom-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            max-width: 400px;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .input-error {
            border-color: #e53e3e !important;
            background-color: #fef2f2;
        }
        
        .step {
            display: none;
        }
        
        .step.active {
            display: block;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #e53e3e, #c53030);
            transition: width 0.3s ease;
        }
        
        .legal-warning {
            background: linear-gradient(135deg, #fef3c7, #fef3c7);
            border: 2px solid #d97706;
            border-left: 6px solid #d97706;
        }
        
        .legal-checkbox {
            accent-color: #d97706;
        }
    </style>
</head>
<body class="bg-gray-50">
    <nav class="bg-white shadow-md sticky top-0 z-50 ">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-20 items-center">
                <div class="flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                    </svg>
                    <span class="text-2xl font-bold bg-gradient-to-r from-red-500 to-orange-500 bg-clip-text text-transparent">CỨU HỘ QUỐC GIA</span>
                </div>
                <div class="hidden md:flex items-center space-x-8">
                    <a href="index.html" class="nav-link text-gray-700 hover:text-red-500 font-medium transition">Trang chủ</a>
                    <a href="map.html" class="nav-link text-gray-700 hover:text-red-500 font-medium transition">Bản đồ cứu hộ</a>
                    <a href="request.html" class="nav-link text-gray-700 hover:text-red-500 font-medium transition">Bản tin</a>
                    <a href="post.html#report" class="nav-link text-red-500 font-bold transition">Báo tin</a>
                </div>
                <div class="md:hidden flex items-center">
                    <button id="menu-toggle" class="text-gray-700 hover:text-red-600" aria-label="Toggle menu">
                        <i data-feather="menu"></i>
                    </button>
                </div>
            </div>
        </div>
        <div id="mobile-menu" class="hidden md:hidden bg-white py-2 px-4 shadow-lg">
            <a href="index.html#home" class="block py-2 text-gray-700 hover:text-red-600 transition">Trang chủ</a>
            <a href="map.html" class="block py-2 text-gray-700 hover:text-red-600 transition">Bản đồ cứu hộ</a>
            <a href="request.html" class="block py-2 text-red-600 font-bold transition">Bản tin</a>
            <a href="post.html#report" class="block py-2 text-gray-700 hover:text-red-600 transition">Báo tin</a> 
            <a href="login.html" class="block py-2 text-white bg-red-600 rounded-md text-center mt-2">Đăng nhập</a>
        </div>
    </nav>

    <!-- Nút gọi điện khẩn cấp -->
    <div class="emergency-call-btn" onclick="makeEmergencyCall()">
        <i data-feather="phone"></i>
    </div>

    <section id="report" class="hero-section py-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl mx-auto p-6">
                <div class="flex justify-between items-center mb-6">
                   <h3 class="text-2xl font-bold text-gray-900 text-center">Báo Cáo Sự Cố Khẩn Cấp</h3>
                </div>
                
                <!-- Cảnh báo pháp lý -->
                <div class="legal-warning p-4 rounded-r mb-6">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i data-feather="alert-triangle" class="h-5 w-5 text-amber-600"></i>
                        </div>
                        <div class="ml-3">
                            <h4 class="text-sm font-bold text-amber-800">CẢNH BÁO PHÁP LÝ QUAN TRỌNG</h4>
                            <p class="text-sm text-amber-700 font-medium mt-1">
                                HỆ THỐNG NÀY CHỈ SỬ DỤNG CHO CÁC TÌNH HUỐNG KHẨN CẤP THỰC SỰ. 
                                <span class="font-bold">BÁO CÁO SAI SỰ THẬT, CUNG CẤP THÔNG TIN GIẢ MẠO SẼ BỊ XỬ LÝ THEO QUY ĐỊNH CỦA PHÁP LUẬT VIỆT NAM</span> 
                                (Điều 142, 330 Bộ luật Hình sự 2015).
                            </p>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <div class="bg-gray-200 rounded-full h-1">
                        <div id="progress-bar" class="progress-bar rounded-full w-1/2"></div>
                    </div>
                    <div class="flex justify-between text-sm text-gray-500 mt-2">
                        <span>Bước 1: Thông tin cá nhân</span>
                        <span>Bước 2: Chi tiết sự cố</span>
                    </div>
                </div>

                <form id="emergency-report-form" class="space-y-6">
                    <!-- Bước 1: Thông tin cá nhân -->
                    <div class="step active" id="step-1">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="emergency-name" class="block text-sm font-medium text-gray-700 mb-1">Họ và tên *</label>
                                <input type="text" id="emergency-name" required class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500 transition">
                            </div>
                            <div>
                                <label for="cccd" class="block text-sm font-medium text-gray-700 mb-1">Số CCCD *</label>
                                <input type="text" id="cccd" required pattern="[0-9]{12}" title="Số CCCD gồm 12 chữ số" class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500 transition" placeholder="Nhập 12 chữ số CCCD">
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <label for="emergency-phone" class="block text-sm font-medium text-gray-700 mb-1">Số điện thoại *</label>
                            <input type="tel" id="emergency-phone" required pattern="[0-9]{10,11}" title="Số điện thoại Việt Nam (10-11 số)" class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500 transition" placeholder="Nhập số điện thoại">
                        </div>

                        <div class="mt-4">
                            <label for="emergency-email" class="block text-sm font-medium text-gray-700 mb-1">Email (tùy chọn)</label>
                            <input type="email" id="emergency-email" class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500 transition">
                        </div>
                        
                        <!-- Xác nhận thông tin trung thực -->
                        <div class="mt-6 p-4 border border-amber-300 rounded-lg bg-amber-50">
                            <div class="flex items-start">
                                <input type="checkbox" id="confirm-truthful" required class="legal-checkbox mt-1 mr-3 w-4 h-4">
                                <label for="confirm-truthful" class="text-sm text-amber-800 font-medium">
                                    <span class="font-bold">TÔI CAM KẾT:</span> Tất cả thông tin cung cấp trên đây là hoàn toàn trung thực và chính xác. 
                                    Tôi hiểu rằng việc cung cấp thông tin sai sự thật sẽ bị xử lý theo quy định của pháp luật.
                                </label>
                            </div>
                        </div>
                        
                        <div class="mt-6 flex justify-end">
                            <button type="button" id="next-step-1" class="bg-red-600 hover:bg-red-700 text-white py-3 px-6 rounded-md transition shadow-md flex items-center justify-center font-medium">
                                Tiếp theo <i data-feather="arrow-right" class="ml-2 w-4 h-4"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Bước 2: Chi tiết sự cố -->
                    <div class="step" id="step-2">
                        <!-- Cảnh báo ở bước 2 -->
                        <div class="bg-amber-50 border-l-4 border-amber-500 p-4 rounded-r mb-6">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <i data-feather="alert-octagon" class="h-5 w-5 text-amber-600"></i>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm text-amber-700 font-medium">
                                        <span class="font-bold">LƯU Ý QUAN TRỌNG:</span> Chỉ báo cáo các sự cố khẩn cấp thực sự. 
                                        Báo cáo sai gây lãng phí nguồn lực cứu hộ và có thể bị truy cứu trách nhiệm hình sự.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label for="emergency-type" class="block text-sm font-medium text-gray-700 mb-1">Loại sự cố *</label>
                            <select id="emergency-type" required class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500 transition">
                                <option value="">Chọn loại sự cố</option>
                                <option value="fire">Hỏa hoạn</option>
                                <option value="flood">Ngập lụt</option>
                                <option value="traffic">Tai nạn giao thông</option>
                                <option value="medical">Cấp cứu y tế</option>
                                <option value="disaster">Thiên tai khác (bão, lở đất...)</option>
                                <option value="other">Khác (mô tả bên dưới)</option>
                            </select>
                        </div>
                        <div class="mt-4">
                            <label for="emergency-location" class="block text-sm font-medium text-gray-700 mb-1">Địa điểm sự cố *</label>
                            <input type="text" id="emergency-location" placeholder="Nhập địa chỉ chi tiết (ví dụ: Số 123, Đường ABC, Quận 1, TP.HCM)" required class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500 transition">
                            <div class="location-btn" onclick="getCurrentLocation()">
                                <i data-feather="map-pin"></i> Sử dụng vị trí hiện tại
                            </div>
                        </div>
                        <div class="mt-4">
                            <label for="emergency-severity" class="block text-sm font-medium text-gray-700 mb-1">Mức độ nghiêm trọng *</label>
                            <select id="emergency-severity" required class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500 transition">
                                <option value="">Chọn mức độ</option>
                                <option value="low">Thấp (không nguy hiểm tính mạng)</option>
                                <option value="medium">Trung bình (cần hỗ trợ nhanh)</option>
                                <option value="high">Cao (nguy hiểm tính mạng, nhiều người)</option>
                                <option value="critical">Khẩn cấp (cần cứu hộ ngay lập tức)</option>
                            </select>
                        </div>
                        <div class="mt-4">
                            <label for="emergency-description" class="block text-sm font-medium text-gray-700 mb-1">Mô tả chi tiết *</label>
                            <textarea id="emergency-description" rows="5" required class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500 transition" placeholder="Mô tả tình hình hiện tại, nguyên nhân, số người bị thương, nhu cầu hỗ trợ cụ thể..."></textarea>
                        </div>
                        
                        <!-- Phần upload media -->
                        <div class="mt-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tải lên hình ảnh/video (tùy chọn, tối đa 3 file)</label>
                            <div class="flex items-center justify-center w-full">
                                <label class="flex flex-col w-full h-32 border-2 border-dashed border-gray-300 hover:border-red-300 rounded-md cursor-pointer">
                                    <div class="flex flex-col items-center justify-center pt-7">
                                        <i data-feather="upload" class="w-8 h-8 text-gray-400"></i>
                                        <p class="pt-1 text-sm text-gray-600">Kéo thả file vào đây hoặc click để chọn (ảnh/video)</p>
                                    </div>
                                    <input type="file" class="hidden" id="emergency-media" multiple accept="image/*,video/*">
                                </label>
                            </div>
                            <div id="media-preview" class="mt-4 grid grid-cols-3 gap-4"></div>
                        </div>
                        
                        <!-- Xác nhận cuối cùng trước khi gửi -->
                        <div class="mt-6 p-4 border border-red-300 rounded-lg bg-red-50">
                            <div class="flex items-start">
                                <input type="checkbox" id="confirm-emergency" required class="legal-checkbox mt-1 mr-3 w-4 h-4">
                                <label for="confirm-emergency" class="text-sm text-red-800 font-medium">
                                    <span class="font-bold">XÁC NHẬN CUỐI CÙNG:</span> Đây là tình huống khẩn cấp thực sự cần sự hỗ trợ 
                                    của lực lượng cứu hộ. Tôi cam kết thông tin cung cấp là hoàn toàn chính xác.
                                </label>
                            </div>
                        </div>
                        
                        <div class="mt-6 flex justify-between">
                            <button type="button" id="prev-step-2" class="bg-gray-600 hover:bg-gray-700 text-white py-3 px-6 rounded-md transition shadow-md flex items-center justify-center font-medium">
                                <i data-feather="arrow-left" class="mr-2 w-4 h-4"></i> Quay lại
                            </button>
                            <button type="submit" class="bg-red-600 hover:bg-red-700 text-white py-3 px-6 rounded-md transition shadow-md flex items-center justify-center font-medium">
                                <i data-feather="send" class="mr-2 w-4 h-4"></i> Gửi Báo Cáo Khẩn
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <!-- Modal xác nhận thành công -->
    <div id="success-modal" class="success-modal">
        <div class="success-modal-content">
            <div class="success-icon">
                <i data-feather="check-circle"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">Báo Cáo Đã Được Gửi Thành Công!</h3>
            <p class="text-gray-600 mb-6">Đội cứu hộ sẽ liên hệ với bạn trong thời gian sớm nhất. Vui lòng giữ liên lạc.</p>
            <div class="flex justify-center space-x-4">
                <button onclick="closeSuccessModal()" class="bg-red-600 hover:bg-red-700 text-white py-2 px-6 rounded-md transition">
                    Đóng
                </button>
                <button onclick="makeEmergencyCall()" class="bg-green-600 hover:bg-green-700 text-white py-2 px-6 rounded-md transition flex items-center">
                    <i data-feather="phone" class="mr-2 w-4 h-4"></i> Gọi Ngay 114
                </button>
            </div>
        </div>
    </div>

    <footer class="bg-gray-900 text-white py-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-12">
                <div>
                    <div class="flex items-center mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                        </svg>
                        <span class="text-2xl font-bold bg-gradient-to-r from-red-500 to-orange-500 bg-clip-text text-transparent">CỨU HỘ QUỐC GIA</span>
                    </div>
                    <p class="text-gray-400 leading-relaxed">Kết nối người dân với lực lượng cứu hộ trong các tình huống khẩn cấp.</p>
                </div>
                <div>
                    <h4 class="font-bold mb-4">Dịch Vụ</h4>
                    <ul class="space-y-2">
                        <li><a href="#" class="text-gray-400 hover:text-white transition">Cứu hỏa</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition">Cứu hộ giao thông</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition">Y tế khẩn cấp</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition">Ứng phó thiên tai</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-bold mb-4">Liên Kết</h4>
                    <ul class="space-y-2">
                        <li><a href="#" class="text-gray-400 hover:text-white transition">Bộ Công An</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition">Bộ Y Tế</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition">Ban Chỉ Đạo PCTT</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition">Cục Cứu Hộ Cứu Nạn</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-bold mb-4">Hỗ Trợ</h4>
                    <ul class="space-y-2">
                        <li><a href="#" class="text-gray-400 hover:text-white transition">Câu hỏi thường gặp</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition">Hướng dẫn sử dụng</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition">Chính sách bảo mật</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition">Điều khoản dịch vụ</a></li>
                    </ul>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-12 pt-8 text-center text-gray-400">
                <p>© 2023 Hệ Thống Cứu Hộ Quốc Gia. Bản quyền thuộc về Bộ Công An.</p>
            </div>
        </div>
    </footer>
    
    <script>
        // === CONFIGURATION ===
        const CONFIG = {
            totalSteps: 2,
            maxMediaFiles: 3,
            phoneRegex: /^(0[3|5|7|8|9])[0-9]{8}$/,
            cccdRegex: /^[0-9]{12}$/,
            emergencyTypes: {
                fire: 'Hỏa hoạn',
                flood: 'Ngập lụt', 
                traffic: 'Tai nạn giao thông',
                medical: 'Cấp cứu y tế',
                disaster: 'Thiên tai',
                other: 'Sự cố khác'
            },
            severityLevels: {
                low: 'Thấp',
                medium: 'Trung bình', 
                high: 'Cao',
                critical: 'Rất cao (Khẩn cấp)'
            },
            typeMapping: {
                fire: 'tai-nan',
                flood: 'thien-tai',
                traffic: 'tai-nan',
                medical: 'cuu-ho',
                disaster: 'thien-tai',
                other: 'canh-bao'
            }
        };

        // === STATE MANAGEMENT ===
        let currentStep = 1;

        // === INITIALIZATION ===
        document.addEventListener('DOMContentLoaded', function() {
            // Khởi tạo Feather Icons
            feather.replace();
            
            // Hiển thị bước đầu tiên
            showStep(1);
            
            // Thiết lập event listeners
            setupEventListeners();
            setupMediaPreview();
            setupRealTimeValidation();
            setupFormSubmission();
        });

        // === PROGRESS MANAGEMENT ===
        function updateProgress() {
            const progressBar = document.getElementById('progress-bar');
            if (progressBar) {
                progressBar.style.width = `${(currentStep / CONFIG.totalSteps) * 100}%`;
            }
        }

        function showStep(step) {
            // Ẩn tất cả các bước
            document.querySelectorAll('.step').forEach(s => {
                s.classList.remove('active');
            });
            
            // Hiển thị bước hiện tại
            const stepElement = document.getElementById(`step-${step}`);
            if (stepElement) {
                stepElement.classList.add('active');
                currentStep = step;
                updateProgress();
                
                // Cuộn mượt đến đầu form
                stepElement.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start',
                    inline: 'nearest'
                });
            }
        }

        // === STEP NAVIGATION ===
        function nextStep(targetStep) {
            if (validateStep(currentStep)) {
                showStep(targetStep);
            }
        }

        function prevStep(targetStep) {
            showStep(targetStep);
        }

        // === VALIDATION ===
        function validateStep(step) {
            const stepElement = document.getElementById(`step-${step}`);
            if (!stepElement) return true;

            const requiredFields = stepElement.querySelectorAll(
                'input[required], select[required], textarea[required]'
            );
            
            let isValid = true;
            let firstInvalidField = null;

            requiredFields.forEach(field => {
                const value = field.value.trim();
                let fieldValid = true;

                // Kiểm tra trống
                if (!value) {
                    fieldValid = false;
                }
                
                // Kiểm tra số điện thoại
                else if (field.type === 'tel' && field.id === 'emergency-phone') {
                    fieldValid = validatePhone(value);
                    if (!fieldValid) {
                        showFieldError(field, 'Số điện thoại không hợp lệ. Vui lòng nhập số 10 chữ số bắt đầu bằng 0.');
                    }
                }
                
                // Kiểm tra CCCD
                else if (field.id === 'cccd') {
                    fieldValid = validateCCCD(value);
                    if (!fieldValid) {
                        showFieldError(field, 'Số CCCD không hợp lệ. Vui lòng nhập đúng 12 chữ số.');
                    }
                }

                if (!fieldValid) {
                    field.classList.add('border-red-500', 'input-error');
                    isValid = false;
                    if (!firstInvalidField) firstInvalidField = field;
                } else {
                    field.classList.remove('border-red-500', 'input-error');
                    clearFieldError(field);
                }
            });

            if (!isValid && firstInvalidField) {
                showError('Vui lòng điền đầy đủ và đúng thông tin bắt buộc (*).');
                firstInvalidField.focus();
            }

            return isValid;
        }

        function validatePhone(phone) {
            return CONFIG.phoneRegex.test(phone);
        }

        function validateCCCD(cccd) {
            return CONFIG.cccdRegex.test(cccd);
        }

        function showFieldError(field, message) {
            // Xóa thông báo lỗi cũ
            clearFieldError(field);
            
            // Thêm thông báo lỗi mới
            const errorElement = document.createElement('p');
            errorElement.className = 'text-red-500 text-xs mt-1';
            errorElement.textContent = message;
            errorElement.id = `${field.id}-error`;
            
            field.parentNode.appendChild(errorElement);
        }

        function clearFieldError(field) {
            const existingError = document.getElementById(`${field.id}-error`);
            if (existingError) {
                existingError.remove();
            }
        }

        // === MEDIA PREVIEW ===
        function setupMediaPreview() {
            const mediaInput = document.getElementById('emergency-media');
            const preview = document.getElementById('media-preview');
            if (!mediaInput || !preview) return;

            mediaInput.addEventListener('change', e => {
                preview.innerHTML = '';
                const files = Array.from(e.target.files).slice(0, CONFIG.maxMediaFiles);
                
                files.forEach((file, index) => {
                    const div = document.createElement('div');
                    div.className = 'media-preview-item relative';

                    let mediaEl;
                    if (file.type.startsWith('image/')) {
                        mediaEl = document.createElement('img');
                        mediaEl.src = URL.createObjectURL(file);
                        mediaEl.className = 'w-full h-24 object-cover rounded-lg';
                    } else if (file.type.startsWith('video/')) {
                        mediaEl = document.createElement('video');
                        mediaEl.src = URL.createObjectURL(file);
                        mediaEl.className = 'w-full h-24 object-cover rounded-lg';
                        mediaEl.controls = true;
                    }
                    
                    if (mediaEl) div.appendChild(mediaEl);

                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.className = 'remove-btn';
                    removeBtn.innerHTML = '×';
                    removeBtn.onclick = () => {
                        div.remove();
                        const dt = new DataTransfer();
                        const filesArr = Array.from(mediaInput.files);
                        filesArr.splice(index, 1);
                        filesArr.forEach(f => dt.items.add(f));
                        mediaInput.files = dt.files;
                    };
                    div.appendChild(removeBtn);

                    preview.appendChild(div);
                });
            });
        }

        // === REAL-TIME VALIDATION ===
        function setupRealTimeValidation() {
            document.querySelectorAll('input[required], select[required], textarea[required]').forEach(input => {
                input.addEventListener('input', () => {
                    input.classList.remove('border-red-500', 'input-error');
                    clearFieldError(input);
                });
            });

            const phoneInput = document.getElementById('emergency-phone');
            if (phoneInput) {
                phoneInput.addEventListener('blur', function() {
                    if (this.value && !validatePhone(this.value)) {
                        this.classList.add('border-red-500', 'input-error');
                        showFieldError(this, 'Số điện thoại không hợp lệ. Vui lòng nhập số 10 chữ số bắt đầu bằng 0.');
                    }
                });
            }

            const cccdInput = document.getElementById('cccd');
            if (cccdInput) {
                cccdInput.addEventListener('blur', function() {
                    if (this.value && !validateCCCD(this.value)) {
                        this.classList.add('border-red-500', 'input-error');
                        showFieldError(this, 'Số CCCD không hợp lệ. Vui lòng nhập đúng 12 chữ số.');
                    }
                });
            }
        }

        // === FORM SUBMISSION ===
        function setupFormSubmission() {
            const form = document.getElementById('emergency-report-form');
            if (!form) return;

            form.addEventListener('submit', async e => {
                e.preventDefault();
                if (!validateStep(currentStep)) return;

                // Hiển thị cảnh báo cuối cùng trước khi gửi
                const isConfirmed = confirm(
                    "CẢNH BÁO PHÁP LÝ CUỐI CÙNG:\n\n" +
                    "Bạn sắp gửi báo cáo khẩn cấp. Việc cung cấp thông tin sai sự thật:\n" +
                    "• Gây lãng phí nguồn lực cứu hộ\n" +
                    "• Có thể bị xử phạt hành chính hoặc truy cứu trách nhiệm hình sự\n" +
                    "• Ảnh hưởng đến công tác cứu hộ thực sự\n\n" +
                    "Bạn có CHẮC CHẮN đây là tình huống khẩn cấp thực sự và thông tin cung cấp là hoàn toàn chính xác?"
                );

                if (!isConfirmed) {
                    return;
                }

                const submitBtn = form.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<span class="animate-spin mr-2">⟳</span> Đang gửi...';
                submitBtn.disabled = true;

                try {
                    const reportData = await createReportData();
                    const success = saveReportToNewsPage(reportData);

                    if (success) {
                        showSuccessModal();
                    } else {
                        throw new Error('Lỗi lưu dữ liệu');
                    }
                } catch (err) {
                    console.error(err);
                    showError('❌ Có lỗi xảy ra khi gửi báo cáo. Vui lòng thử lại.');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            });
        }

        // === TẠO DỮ LIỆU BÁO CÁO ===
        async function createReportData() {
            const type = document.getElementById('emergency-type').value;
            const location = document.getElementById('emergency-location').value;
            const mediaFiles = document.getElementById('emergency-media').files;
            const img = mediaFiles.length > 0
                ? URL.createObjectURL(mediaFiles[0])
                : 'https://images.unsplash.com/photo-1614732414444-096e5f1122d5?w=600&h=400&fit=crop';

            return {
                id: 'user_' + Date.now(),
                title: `[BÁO CÁO] ${CONFIG.emergencyTypes[type] || 'Sự cố khẩn cấp'} tại ${location}`,
                date: new Date().toISOString().split('T')[0],
                type: CONFIG.typeMapping[type] || 'canh-bao',
                location: generateLocationCode(location),
                img,
                content: document.getElementById('emergency-description').value,
                severity: document.getElementById('emergency-severity').value,
                reporter: {
                    name: document.getElementById('emergency-name').value,
                    cccd: document.getElementById('cccd').value,
                    phone: document.getElementById('emergency-phone').value,
                    email: document.getElementById('emergency-email').value || '',
                    legalConfirmed: true,
                    timestamp: new Date().toISOString()
                },
                timestamp: new Date().toISOString(),
                status: 'pending',
                verified: false,
                source: 'user_report'
            };
        }

        function generateLocationCode(locationText) {
            return locationText
                ? locationText.split(',')[0].trim().toLowerCase().replace(/\s+/g, '-').normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                : 'toan-quoc';
        }

        function saveReportToNewsPage(report) {
            try {
                const reports = JSON.parse(localStorage.getItem('newsData_user_reports') || '[]');
                reports.unshift(report);
                if (reports.length > 100) reports.splice(100);
                localStorage.setItem('newsData_user_reports', JSON.stringify(reports));
                return true;
            } catch (err) {
                console.error(err);
                return false;
            }
        }

        // === LOCATION SERVICES ===
        async function getCurrentLocation() {
            if (navigator.geolocation) {
                const locationInput = document.getElementById('emergency-location');
                const locationBtn = document.querySelector('.location-btn');
                const originalText = locationBtn.innerHTML;
                
                // Hiển thị trạng thái loading
                locationBtn.innerHTML = '<div class="location-loading"></div> Đang lấy vị trí...';
                locationBtn.classList.add('loading');
                locationBtn.disabled = true;
                
                const originalPlaceholder = locationInput.placeholder;
                locationInput.placeholder = 'Đang lấy vị trí...';
                
                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            timeout: 15000,
                            enableHighAccuracy: true
                        });
                    });
                    
                    const latitude = position.coords.latitude;
                    const longitude = position.coords.longitude;
                    
                    // Hiển thị tọa độ tạm thời
                    locationInput.value = `Đang lấy địa chỉ... (${latitude.toFixed(6)}, ${longitude.toFixed(6)})`;
                    
                    // Gọi API để lấy địa chỉ
                    const address = await getAddressFromCoordinates(latitude, longitude);
                    
                    if (address) {
                        locationInput.value = address;
                        showSuccess('✅ Đã lấy địa chỉ thành công!');
                    } else {
                        locationInput.value = `Vị trí: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
                        showSuccess('✅ Đã lấy tọa độ! Vui lòng bổ sung địa chỉ nếu cần.');
                    }
                    
                } catch (error) {
                    console.error("Lỗi khi lấy vị trí:", error);
                    handleLocationError(error);
                } finally {
                    // Khôi phục trạng thái ban đầu
                    locationBtn.innerHTML = originalText;
                    locationBtn.classList.remove('loading');
                    locationBtn.disabled = false;
                    locationInput.placeholder = originalPlaceholder;
                }
            } else {
                showError('❌ Trình duyệt không hỗ trợ định vị. Vui lòng nhập thủ công.');
            }
        }

        // === GEOCODING SERVICE ===
        async function getAddressFromCoordinates(lat, lng) {
            try {
                // Sử dụng OpenStreetMap Nominatim API (miễn phí)
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`
                );
                
                if (!response.ok) {
                    throw new Error('Lỗi kết nối dịch vụ địa chỉ');
                }
                
                const data = await response.json();
                
                if (data && data.address) {
                    return formatAddress(data);
                }
                
                return null;
            } catch (error) {
                console.error('Lỗi khi lấy địa chỉ:', error);
                return null;
            }
        }

        // === FORMAT ADDRESS ===
        function formatAddress(data) {
            const address = data.address;
            let formattedAddress = '';
            
            // Xây dựng địa chỉ từ chi tiết đến tổng quát
            if (address.road) {
                formattedAddress += address.road;
            }
            
            if (address.house_number) {
                formattedAddress += ' số ' + address.house_number;
            }
            
            if (address.suburb && !formattedAddress.includes(address.suburb)) {
                formattedAddress += formattedAddress ? ', ' + address.suburb : address.suburb;
            }
            
            if (address.quarter && !formattedAddress.includes(address.quarter)) {
                formattedAddress += formattedAddress ? ', ' + address.quarter : address.quarter;
            }
            
            if (address.neighbourhood && !formattedAddress.includes(address.neighbourhood)) {
                formattedAddress += formattedAddress ? ', ' + address.neighbourhood : address.neighbourhood;
            }
            
            if (address.city_district && !formattedAddress.includes(address.city_district)) {
                formattedAddress += formattedAddress ? ', ' + address.city_district : address.city_district;
            }
            
            if (address.district && !formattedAddress.includes(address.district)) {
                formattedAddress += formattedAddress ? ', ' + address.district : address.district;
            }
            
            if (address.city && !formattedAddress.includes(address.city)) {
                formattedAddress += formattedAddress ? ', ' + address.city : address.city;
            }
            
            if (address.town && !formattedAddress.includes(address.town)) {
                formattedAddress += formattedAddress ? ', ' + address.town : address.town;
            }
            
            if (address.province && !formattedAddress.includes(address.province)) {
                formattedAddress += formattedAddress ? ', ' + address.province : address.province;
            }
            
            if (address.state && !formattedAddress.includes(address.state)) {
                formattedAddress += formattedAddress ? ', ' + address.state : address.state;
            }
            
            if (address.country && !formattedAddress.includes(address.country)) {
                formattedAddress += formattedAddress ? ', ' + address.country : address.country;
            }
            
            return formattedAddress || data.display_name || '';
        }

        // === HANDLE LOCATION ERRORS ===
        function handleLocationError(error) {
            let errorMessage = '❌ Không thể lấy vị trí. Vui lòng nhập thủ công.';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = '❌ Quyền truy cập vị trí bị từ chối. Vui lòng cho phép truy cập vị trí.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = '❌ Thông tin vị trí không khả dụng.';
                    break;
                case error.TIMEOUT:
                    errorMessage = '❌ Hết thời gian lấy vị trí. Vui lòng thử lại.';
                    break;
            }
            
            showError(errorMessage);
        }

        // === EMERGENCY CALL ===
        function makeEmergencyCall() {
            if (confirm("Bạn có chắc chắn muốn gọi số cứu hộ khẩn cấp 114?")) {
                // Trong thực tế: window.location.href = "tel:114";
                alert("Đang kết nối với số cứu hộ khẩn cấp 114...");
            }
        }

        // === SUCCESS MODAL ===
        function showSuccessModal() {
            document.getElementById('success-modal').style.display = 'flex';
            feather.replace();
        }

        function closeSuccessModal() {
            document.getElementById('success-modal').style.display = 'none';
            // Reset form và quay về bước 1
            document.getElementById('emergency-report-form').reset();
            document.getElementById('media-preview').innerHTML = '';
            showStep(1);
            
            // Chuyển hướng sau 3 giây
            setTimeout(() => {
                window.location.href = 'request.html';
            }, 3000);
        }

        // === NOTIFICATION SYSTEM ===
        function showError(msg) { 
            showNotification(msg, 'error'); 
        }
        
        function showSuccess(msg) { 
            showNotification(msg, 'success'); 
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `custom-notification ${
                type === 'error' ? 'bg-red-500' : 
                type === 'success' ? 'bg-green-500' : 'bg-blue-500'
            } text-white`;
            
            notification.innerHTML = `
                <div class="flex justify-between items-center">
                    <span>${message}</span>
                    <button class="ml-4 text-white hover:text-gray-200">×</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Tự động xóa sau 5 giây
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
            
            // Xóa khi click
            notification.querySelector('button').addEventListener('click', () => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            });
        }

        // === EVENT LISTENERS SETUP ===
        function setupEventListeners() {
            // Navigation buttons
            document.getElementById('next-step-1').addEventListener('click', () => nextStep(2));
            document.getElementById('prev-step-2').addEventListener('click', () => prevStep(1));
            
            // Mobile menu
            document.getElementById('menu-toggle').addEventListener('click', function() {
                const mobileMenu = document.getElementById('mobile-menu');
                mobileMenu.classList.toggle('hidden');
            });
        }

        // Xuất global functions cho HTML
        window.nextStep = nextStep;
        window.prevStep = prevStep;
        window.showStep = showStep;
        window.getCurrentLocation = getCurrentLocation;
        window.makeEmergencyCall = makeEmergencyCall;
        window.closeSuccessModal = closeSuccessModal;
    </script>
</body>
</html>